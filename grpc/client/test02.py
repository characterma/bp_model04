#!/usr/bin/python
# -*- coding: utf-8 -*-

import sys
sys.path.append(r'grpc/proto/')
sys.path.append(r'utils/')
import numpy as np
import pandas as pd
import grpc
import anbp_pb2, anbp_pb2_grpc
from andun_sql.andun_sql import AndunSql
import time

# IP = "192.168.100.122:50056"
# IP = "192.168.100.122:50057"
# IP = "192.168.100.33:50057"
# IP = "192.168.100.45:50057"
# IP = "192.168.100.232:50057"
# IP = "192.168.100.232:50056"
# IP = "39.96.40.181:50057"
# IP = "47.95.198.148:50057"
# IP = "39.97.104.203:50057"

# 武轩 血压模型 的地址
# IP = "39.102.54.99:50060"

# 线上 NG 的地址
IP = "39.97.198.78:50057"

# 旧模型 NG 的地址
# IP = "47.95.230.250:50056"
# IP = "47.94.169.147:50056"
# IP = "39.107.44.4:50056"
# IP = "39.107.40.248:50056"

# test_bp_features = "2.25085,0.59804,0.25490,0.85784,0.12745,0.44145,0.55855,0.22688,0.31303,883.71198,1108.14832,3429.66992,3.08876,0.64706,0.28431,0.93627,0.13725,0.44145,0.55855,0.24410,0.33659,1496.56177,1880.57471,5394.35059,3.19822,0.69608,0.30392,1.00980,0.14706,0.45306,0.54694,0.26126,0.35021,1603.76343,2094.39258,5960.28125,3.32031,0.70588,0.30392,1.00980,0.14706,0.46925,0.53075,0.26748,0.34869,1862.28906,2126.31738,6029.60059,3.70514,0.71079,0.29902,1.00980,0.14706,0.46816,0.53184,0.26186,0.33076,1840.14758,2185.86133,6710.45898,3.74268,0.71079,0.29902,1.00980,0.14706,0.46354,0.53646,0.26616,0.32379,1874.84888,2220.48364,6781.02051,3.67780,0.69608,0.29412,0.99020,0.14706,0.46502,0.53498,0.26616,0.30856,1843.60999,2077.30835,6596.97803"

# features_1 = "3.71283,0.43628,0.21569,0.65687,0.11765,0.48484,0.51516,0.15353,0.17065,834.87836,865.17395,5138.44922,4.03782,0.44118,0.22549,0.66177,0.11765,0.46090,0.53910,0.14795,0.20845,948.71759,1238.56934,5606.43262,2.67713,0.44608,0.20098,0.64706,0.10784,0.51382,0.48618,0.21955,0.23759,1018.35803,1198.87476,3468.54297,2.43411,0.42157,0.21079,0.64216,0.11274,0.53260,0.46740,0.20324,0.21664,793.08868,828.43854,3274.20410,3.10138,0.43627,0.21569,0.65687,0.11764,0.47264,0.52736,0.14836,0.19286,645.58344,849.95502,4294.35059,2.63145,0.47549,0.20588,0.67647,0.10784,0.49130,0.50870,0.17527,0.22104,693.15179,854.33801,3518.31104,3.16459,0.50000,0.22549,0.71568,0.12745,0.51535,0.48465,0.21812,0.21433,857.24084,976.62189,4770.99512,3.67189,0.48530,0.23039,0.71569,0.12745,0.48381,0.51619,0.17054,0.19776,936.61829,1028.86914,5251.23145,3.65795,0.48039,0.22549,0.71078,0.12745,0.47732,0.52268,0.16773,0.18582,931.74475,992.20386,5227.28271"
# features_2 = "4.48897,0.47059,0.23529,0.70098,0.12255,0.42885,0.57115,0.16429,0.21900,1106.11426,1437.97852,6881.58887,6.98279,0.46078,0.22549,0.68627,0.11765,0.43316,0.56684,0.16214,0.19934,1617.22803,1923.03467,9597.71875,6.15096,0.48530,0.21569,0.70098,0.11765,0.50277,0.49723,0.19711,0.20554,1835.15088,1886.95117,8557.81836,5.40624,0.51961,0.23039,0.73529,0.12255,0.51199,0.48801,0.21695,0.24724,1633.11572,1727.74170,7621.78906,4.00731,0.52941,0.23529,0.75490,0.12745,0.48230,0.51770,0.20398,0.23796,1218.39441,1458.08130,5841.74268,3.50115,0.49510,0.23530,0.74020,0.12745,0.48849,0.51151,0.19688,0.21754,1023.58038,1126.37036,5048.31836,3.19578,0.46568,0.23529,0.69118,0.12745,0.47162,0.52838,0.17531,0.22094,839.50500,1040.21509,4651.58594,3.39841,0.46078,0.22549,0.68627,0.12745,0.44567,0.55433,0.15877,0.20145,812.32111,962.29749,4804.76855,3.09828,0.46078,0.22549,0.68627,0.12745,0.44700,0.55300,0.16296,0.19866,766.70526,908.78113,4394.72656,2.69911,0.44117,0.22549,0.66667,0.12255,0.44502,0.55498,0.16409,0.20906,609.44629,830.30157,3906.75342"
# features_3 = "4.26479,0.46078,0.25000,0.71078,0.11765,0.41617,0.58383,0.18229,0.28438,1201.12988,1887.87793,6826.85254,3.05225,0.43137,0.22549,0.63235,0.10784,0.44048,0.55952,0.20643,0.28873,1001.40637,1310.14771,4211.67041,2.85727,0.39216,0.21569,0.60784,0.11275,0.41788,0.58212,0.13595,0.27979,621.34100,1004.82501,3928.86279,3.17048,0.37255,0.21569,0.59804,0.11275,0.38194,0.61806,0.12891,0.26316,637.01147,1066.42285,4392.25977,2.71812,0.38725,0.21569,0.60784,0.10784,0.40457,0.59543,0.13542,0.26597,578.37115,988.93121,3548.36963,2.88903,0.40196,0.21078,0.61765,0.10784,0.47694,0.52306,0.16902,0.23071,698.20020,934.21704,4035.16382,3.26730,0.40196,0.20588,0.60784,0.10784,0.47126,0.52874,0.16902,0.21524,757.10071,934.97333,4304.11182,3.31905,0.38726,0.21078,0.60294,0.10784,0.43656,0.56344,0.14800,0.25194,725.04163,1130.33887,4389.05957,3.29389,0.38236,0.22549,0.60784,0.11275,0.40267,0.59733,0.13175,0.28777,725.04163,1233.95764,4530.02344,2.90412,0.37255,0.21569,0.58823,0.10784,0.41082,0.58918,0.13056,0.23549,656.74585,934.79651,3819.83911,2.90703,0.37255,0.20588,0.58823,0.10784,0.45708,0.54292,0.14235,0.21812,671.87866,871.81396,3871.94165,4.92955,0.38236,0.20588,0.58824,0.10784,0.45309,0.54691,0.14235,0.18975,963.31177,1143.17712,6348.91504,5.02534,0.38726,0.21569,0.59314,0.10784,0.45171,0.54829,0.13414,0.18403,1011.41333,1295.27710,6859.32031,4.67399,0.38235,0.21569,0.59804,0.10784,0.43286,0.56714,0.13120,0.21505,854.86926,1297.47827,6205.81787,3.84987,0.39216,0.21569,0.60784,0.10784,0.42208,0.57792,0.13748,0.20883,745.78613,1041.17505,5425.06934,3.65287,0.39706,0.21569,0.60784,0.10784,0.42208,0.57792,0.13888,0.20166,738.68341,964.92847,5036.16895,3.67806,0.39216,0.21569,0.59314,0.11274,0.40129,0.59871,0.13233,0.22051,721.66980,1135.37158,5054.87695"
# features_4 = "2.09734,0.42157,0.22549,0.64216,0.10784,0.45749,0.54251,0.22497,0.28242,661.06335,772.11450,2783.84619,5.08306,0.45098,0.22549,0.66666,0.11765,0.45496,0.54504,0.20352,0.23686,1130.36316,1348.42285,6808.00684,6.10485,0.45098,0.22549,0.66666,0.11765,0.44134,0.55866,0.16378,0.22087,1442.84082,1831.67041,8635.95703,4.95869,0.44608,0.20588,0.64705,0.10784,0.47401,0.52599,0.18226,0.24460,1332.00391,1643.39221,6610.14844,4.47786,0.44118,0.21568,0.65686,0.11274,0.47402,0.52598,0.16465,0.22313,1224.56177,1406.36987,6382.79492,4.29767,0.44118,0.22549,0.66667,0.11765,0.43639,0.56361,0.15670,0.22313,1131.71704,1414.65747,6405.79395"
# features_5 = "4.32536,0.50980,0.24510,0.75980,0.13725,0.45529,0.54471,0.18653,0.23692,1542.80591,1727.82129,6226.59766,5.77866,0.50490,0.24510,0.74020,0.12745,0.43907,0.56093,0.18004,0.28381,1960.98486,2683.86768,9055.74805,5.83573,0.43628,0.24510,0.67647,0.12745,0.43491,0.56509,0.16015,0.28548,1682.96729,2342.36230,8866.72461,6.34344,0.43137,0.22549,0.65686,0.11275,0.43158,0.56842,0.16008,0.29658,1795.73535,2307.40576,8921.81445,6.98115,0.46078,0.23039,0.69608,0.12745,0.48021,0.51979,0.17311,0.22583,1982.28723,2202.21875,10383.86719,7.92241,0.49510,0.24510,0.73529,0.12745,0.46092,0.53908,0.17535,0.21890,2204.45166,2624.64502,11940.10547,8.05115,0.50490,0.25000,0.75000,0.12745,0.44779,0.55221,0.18001,0.22636,2246.64502,2838.99414,12411.58203,7.47045,0.50000,0.25490,0.75980,0.13235,0.43767,0.56233,0.17734,0.24517,2149.39551,2778.54980,11445.53711,7.03994,0.50000,0.25980,0.76471,0.13725,0.43345,0.56655,0.17720,0.26332,2118.38867,2839.34741,11177.79297,6.87882,0.45098,0.25490,0.69608,0.13725,0.46383,0.53617,0.17889,0.22876,1900.07715,2575.32031,11050.06934,6.85327,0.45098,0.24510,0.70098,0.12745,0.45468,0.54532,0.17972,0.22254,1854.45166,2570.71729,10060.75000,6.94354,0.48039,0.24020,0.72059,0.12745,0.46063,0.53937,0.17203,0.23320,1910.47192,2499.15210,10229.00391"
# features_6 = "9.40277,0.48039,0.22549,0.70098,0.11765,0.48324,0.51676,0.16402,0.18523,2335.56934,2371.82178,13093.86230,10.36426,0.49020,0.22549,0.72059,0.12745,0.45296,0.54704,0.16568,0.19862,2528.11963,3036.77832,14361.83984"
# features_7 = "1.68086,0.80882,0.35294,1.15687,0.18627,0.54875,0.45125,0.28615,0.29052,1060.27576,1053.96021,3457.95410,1.57882,0.80392,0.35294,1.17157,0.19118,0.50509,0.49491,0.26049,0.29422,1003.39160,1034.94507,3352.84668,1.54119,0.81372,0.35294,1.18628,0.18628,0.50509,0.49491,0.25669,0.29882,1015.69788,1015.49670,3347.61475,1.52292,0.80392,0.36765,1.17647,0.19118,0.50785,0.49215,0.27650,0.30066,1015.69788,1027.53418,3371.62891,1.65383,0.79902,0.37255,1.18137,0.20098,0.51579,0.48421,0.27992,0.30137,1046.15649,1048.45312,3533.44775,1.64863,0.79412,0.36274,1.17647,0.19608,0.48889,0.51111,0.27137,0.30699,1044.94067,1052.10461,3533.44775,1.61715,0.79902,0.35294,1.16177,0.19608,0.47733,0.52267,0.26019,0.30699,1045.24561,1076.26709,3462.27856,1.62742,0.80882,0.34313,1.17647,0.19118,0.53005,0.46995,0.27807,0.30440,1099.56885,1034.99268,3461.85986,1.66527,0.80882,0.34314,1.17647,0.19608,0.54494,0.45506,0.29906,0.29513,1119.44385,1034.99268,3519.85376,1.68393,0.79412,0.35784,1.17647,0.19608,0.50953,0.49047,0.28362,0.28632,1031.50244,1139.24573,3565.53784"
# test_bp_features = ",".join([features_1, features_2, features_3, features_4, features_5, features_6, features_7])

# test_bp_features = "4.32536,0.50980,0.24510,0.75980,0.13725,0.45529,0.54471,0.18653,0.23692,1542.80591,1727.82129,6226.59766,5.77866,0.50490,0.24510,0.74020,0.12745,0.43907,0.56093,0.18004,0.28381,1960.98486,2683.86768,9055.74805,5.83573,0.43628,0.24510,0.67647,0.12745,0.43491,0.56509,0.16015,0.28548,1682.96729,2342.36230,8866.72461,6.34344,0.43137,0.22549,0.65686,0.11275,0.43158,0.56842,0.16008,0.29658,1795.73535,2307.40576,8921.81445,6.98115,0.46078,0.23039,0.69608,0.12745,0.48021,0.51979,0.17311,0.22583,1982.28723,2202.21875,10383.86719,7.92241,0.49510,0.24510,0.73529,0.12745,0.46092,0.53908,0.17535,0.21890,2204.45166,2624.64502,11940.10547,8.05115,0.50490,0.25000,0.75000,0.12745,0.44779,0.55221,0.18001,0.22636,2246.64502,2838.99414,12411.58203,7.47045,0.50000,0.25490,0.75980,0.13235,0.43767,0.56233,0.17734,0.24517,2149.39551,2778.54980,11445.53711,7.03994,0.50000,0.25980,0.76471,0.13725,0.43345,0.56655,0.17720,0.26332,2118.38867,2839.34741,11177.79297,6.87882,0.45098,0.25490,0.69608,0.13725,0.46383,0.53617,0.17889,0.22876,1900.07715,2575.32031,11050.06934,6.85327,0.45098,0.24510,0.70098,0.12745,0.45468,0.54532,0.17972,0.22254,1854.45166,2570.71729,10060.75000,6.94354,0.48039,0.24020,0.72059,0.12745,0.46063,0.53937,0.17203,0.23320,1910.47192,2499.15210,10229.00391"
# test_bp_features = "4.32536,0.50980,0.24510,0.75980,0.13725,0.45529,0.54471,0.18653,0.23692,1542.80591,1727.82129,6226.59766"
# test_bp_features = "9.40277,0.48039,0.22549,0.70098,0.11765,0.48324,0.51676,0.16402,0.18523,2335.56934,2371.82178,13093.86230,10.36426,0.49020,0.22549,0.72059,0.12745,0.45296,0.54704,0.16568,0.19862,2528.11963,3036.77832,14361.83984"
# test_bp_features = "8.66891,0.51471,0.23039,0.74510,0.12745,0.50379,0.49621,0.18922,0.19380,2265.68213,2542.35156,12278.53711,9.13125,0.52941,0.23529,0.76471,0.13235,0.49433,0.50567,0.18066,0.19454,2460.48706,2656.55103,13262.73340,8.96721,0.50980,0.23529,0.74510,0.12745,0.48894,0.51106,0.17853,0.18673,2333.10645,2411.02222,13056.86328,9.00588,0.50000,0.23529,0.73039,0.12745,0.48638,0.51362,0.17149,0.18451,2254.10596,2410.68799,13143.61035,9.03724,0.48529,0.22549,0.71079,0.12745,0.48638,0.51362,0.17036,0.18147,2206.29492,2322.01270,12899.43359,8.98766,0.47059,0.22549,0.69608,0.11765,0.50183,0.49817,0.17154,0.16773,2095.21118,2089.06421,12432.84766,9.08262,0.48039,0.21569,0.69608,0.11765,0.51667,0.48333,0.16893,0.16773,2107.19604,2002.59448,12573.81738,8.98203,0.46079,0.21569,0.68137,0.11765,0.50487,0.49513,0.16295,0.17151,1999.92847,1982.68506,12319.22168,8.86327,0.44608,0.21569,0.65686,0.11765,0.50856,0.49144,0.15891,0.17327,1960.24634,2109.90845,12207.57520"

# 异常用户 孙玉玲
# test_bp_features = "66.91143,0.51961,0.27451,0.79412,0.15686,0.51264,0.48736,0.17671,0.17192,19957.44141,18713.42969,111956.92188,67.59972,0.51961,0.27451,0.80392,0.15686,0.51036,0.48964,0.17156,0.16739,19814.59766,19058.70508,113009.72656,67.98824,0.51961,0.28431,0.80392,0.15686,0.50211,0.49789,0.17209,0.16949,19814.59766,19280.61719,114580.07812,67.21175,0.51961,0.27941,0.79902,0.15686,0.49953,0.50047,0.17085,0.17268,19390.24609,19061.37695,113330.23438,65.64696,0.51961,0.27451,0.79412,0.15686,0.49354,0.50646,0.16873,0.17509,18749.59766,19229.96875,110919.84375,66.25830,0.51961,0.27941,0.79902,0.15686,0.50596,0.49404,0.17444,0.17149,19655.97656,19516.20898,113116.56250,67.92998,0.52941,0.28431,0.81372,0.15686,0.51078,0.48922,0.17774,0.17067,20600.38086,20094.15430,116077.25781,72.09558,0.54902,0.28431,0.83333,0.15686,0.52111,0.47889,0.18093,0.16996,21955.66406,20699.05469,121164.84375,69.97380,0.53921,0.28431,0.81373,0.15686,0.52438,0.47562,0.17921,0.16491,21277.04883,19617.60547,118534.96875,68.52913,0.52941,0.27941,0.81373,0.15686,0.52565,0.47435,0.17900,0.16258,20418.71289,18664.64648,115260.45312,69.12547,0.52941,0.27451,0.81373,0.15686,0.51619,0.48381,0.17651,0.16203,20395.48242,18699.10938,116181.71094,69.32881,0.51961,0.27451,0.79412,0.15687,0.50923,0.49077,0.17010,0.16796,19873.40820,19095.94141,116786.00781,66.98955,0.51961,0.27451,0.79412,0.15686,0.50305,0.49695,0.16981,0.16861,19351.82812,19095.94141,112862.06250"
test_bp_features = "69.88052,0.53922,0.27451,0.81373,0.15686,0.52901,0.47099,0.18212,0.16839,21085.06055,20019.63281,115713.99219,75.66089,0.55392,0.27451,0.83333,0.15686,0.53369,0.46631,0.17840,0.16279,22743.31250,20248.04297,122617.78125,77.86742,0.54902,0.27451,0.82353,0.15686,0.53435,0.46565,0.17840,0.15964,21961.37500,20128.56055,123962.28125,79.47229,0.55392,0.26961,0.82353,0.15686,0.53740,0.46260,0.17971,0.15701,22853.98047,19611.02344,126715.25781,80.37427,0.56372,0.27451,0.83824,0.15686,0.55390,0.44610,0.18287,0.15271,24199.98438,19791.30273,127995.14844,80.01438,0.57353,0.27451,0.84314,0.15686,0.55502,0.44498,0.18813,0.15425,24681.22266,19939.38477,127130.24219,79.25215,0.57843,0.27451,0.85294,0.15686,0.55521,0.44479,0.18652,0.15519,23819.40234,19565.85938,126193.82031,79.24715,0.57353,0.27451,0.84314,0.15686,0.56120,0.43880,0.18721,0.15483,23776.84375,19336.84766,126520.34375,78.44693,0.56863,0.27451,0.83824,0.15686,0.55779,0.44221,0.18562,0.15504,23517.91797,19913.85547,126557.86719,77.12534,0.56863,0.27451,0.84314,0.15686,0.54473,0.45527,0.18357,0.15956,23517.91797,19913.85547,125285.31250,75.58044,0.56863,0.27451,0.84313,0.15687,0.54619,0.45381,0.18610,0.15662,22995.96484,19138.60156,120713.05469,74.85057,0.56862,0.26471,0.83333,0.15686,0.54881,0.45119,0.18426,0.15141,22621.47266,18264.45508,118174.46875"
# test_bp_features = "6.685833,0.457031,0.250000,0.705078,0.140625,0.455219,0.544781,0.155270,0.190532,887.917603,1060.229736,5507.356445,6.546752,0.453125,0.251953,0.703125,0.138672,0.454236,0.545764,0.166259,0.190028,949.761353,1092.872559,5692.244141,6.516086,0.457031,0.253906,0.712891,0.142578,0.459940,0.540060,0.154920,0.188680,1036.327759,1212.991211,5746.217773,6.463704,0.457031,0.255859,0.714844,0.144531,0.455940,0.544060,0.153128,0.190226,846.817749,1070.841675,5258.762695"

# test_bp_features = "0.56301,0.48529,0.29902,0.94118,0.08333,0.49430,0.50570,148.79442,150.92412,2199.63892,2602.99951,757.88916,0.86715,0.45098,0.22549,0.75000,0.08823,0.50129,0.49871,0.57379,0.55566,875.75281,770.59082,1115.71570"


# 5ae46115 33f43701   73d3a978  d8877080  fc5cb908  3df13694  c5071592  8d4d2680


def run(wear_user_id):
    user_info = '{"wearUserId": "' + wear_user_id + '","age": 26,"height": 180,"weight": 85,"gender": 1}'
    channel = grpc.insecure_channel(IP)
    stub = anbp_pb2_grpc.GreeterStub(channel=channel)
    response = stub.ANBP(anbp_pb2.BPRequest(userInfo = user_info,
                                             oStatus = "1",
                                             features=test_bp_features,
                                             preReportBP="130,70,90",
                                            #  preReportBP="0,-1",
                                             preReportTimeDiffMinute = "6"))

    # print("status: {}, bloodPpressure: {}, timestamp: {}".format(response.status, response.bloodPpressure, response.timestamp))
    return response.status, response.bloodPpressure


if __name__ == "__main__":

    ansql = AndunSql()
    # 从 andun_watch.d_users_bp_model 查询所有用户
    sql_s = "SELECT wear_user_id,create_time FROM andun_watch.d_user_bp_nn_model_para"
    all_users = ansql.ansql_read_mysql(sql_s)
    all_users = all_users['wear_user_id'].unique()

    for au in all_users:
        status, bp = run(au)
        if status == '1':
            print("调用成功: {} - {} - {} ".format(au, status, bp))
        else:
            print("调用失败: {} - {} - {} ".format(au, status, bp))
        
        time.sleep(1)